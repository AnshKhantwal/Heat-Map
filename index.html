<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Heatmap Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .controls { background: #f8f9fa; padding: 25px; border-bottom: 1px solid #e9ecef; }
        .control-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    align-items: flex-end;
}
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; }
        .control-group select, .control-group button { padding: 12px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: all 0.3s ease; }
        .control-group button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-weight: 600; cursor: pointer; transition: transform 0.2s ease; }
        .control-group button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        #map { width: 100%; height: 600px; background: #e9ecef; }
        .info-panel { background: #f8f9fa; padding: 20px; border-top: 1px solid #e9ecef; font-size: 14px; color: #666; }
        .legend { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 12px; position: absolute; bottom: 50px; right: 20px; z-index: 400; }
        .heatmap-tooltip {
    background: #ffffffee;
    border: 1px solid #dcdcdc;
    padding: 6px 10px;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    font-family: 'Segoe UI', sans-serif;
    color: #333;
}
.app-footer {
    text-align: center;
    padding: 18px;
    margin-top: 20px;
    font-size: 14px;
    color: #ffffff;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.app-footer strong {
    font-weight: 700;
    color: #ffeaa7;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Patient Distribution Heatmap</h1>
            <p>Analyze patient distribution across Delhi branches by area</p>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="branch">Select Branch</label>
                    <select id="branch">
                        <option value="shahdra">Shahdra</option>
                        <option value="keshavpuram">Keshavpuram</option>
                        <option value="mayur-vihar">Mayur Vihar</option>
                    </select>
                </div>
                
                <div class="control-group">
    <label for="startMonth">From Month</label>
    <select id="startMonth">
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
</div>

<div class="control-group">
    <label for="endMonth">To Month</label>
    <select id="endMonth">
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
</div>
                
                <div class="control-group">
                    <label for="year">Select Year</label>
                    <select id="year">
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <button onclick="generateHeatmap()">üîç Search & Update</button>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
        
        <div class="info-panel">
            <strong>Selected:</strong> <span id="selection-info">Shahdra - January 2023</span>
            <br><strong>Total Patients:</strong> <span id="patient-count">0</span>
        </div>
    </div>

    <!-- load data files -->
    <script src="data/shahdra.js"></script>
    <script src="data/keshavpuram.js"></script>
    <script src="data/mayurvihar.js"></script>

    <script>
        // Compose patientData from loaded window variables
        const patientData = {
            shahdra: window.data_shahdra,
            keshavpuram: window.data_keshavpuram,
            "mayur-vihar": window.data_mayurvihar
        };

        let map;
        let circleMarkers = [];

        function getColor(count) {
    return count > 80 ? '#d73027' :     // dark red
           count > 60 ? '#fc8d59' :     // orange
           count > 40 ? '#fee08b' :     // yellow
           count > 20 ? '#66bd63' :     // medium green
           count > 10 ? '#1a9850' :     // darker green
                         '#a6d96a';     // light green
}


        function initMap() {
            // default view - if shahdra has a center use it, else use Delhi center
            const defaultCenter = (patientData.shahdra && patientData.shahdra.center) ? patientData.shahdra.center : [28.6139, 77.2090];
            map = L.map('map').setView(defaultCenter, 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                opacity: 0.55 
            }).addTo(map);
        }

        function generateHeatmap() {
    try {
        const branch = document.getElementById('branch').value;
        const year = document.getElementById('year').value;
        const startMonth = parseInt(document.getElementById('startMonth').value);
        const endMonth = parseInt(document.getElementById('endMonth').value);

        // Build month array
        let monthList = [];
        for (let m = startMonth; m <= endMonth; m++) {
            let mm = m.toString().padStart(2, '0');
            monthList.push(`${year}-${mm}`);
        }

        const branchData = patientData[branch];
        if (!branchData || !branchData.areas) {
            alert('No data available for selected branch.');
            return;
        }

        let totalPatients = 0;

        // Clear existing markers
        circleMarkers.forEach(marker => map.removeLayer(marker));
        circleMarkers = [];

        branchData.areas.forEach(area => {
            let patientCount = 0;

            // Sum patient counts across range
            monthList.forEach(m => {
                patientCount += (area.patients[m] || 0);
            });

            totalPatients += patientCount;

            if (patientCount < 1) return;

            // Radius scale
            const radius =
                patientCount <= 3 ? 14 :
                patientCount <= 10 ? 18 :
                patientCount <= 20 ? 24 :
                patientCount <= 40 ? 30 :
                patientCount <= 70 ? 38 :
                46;

            const color = getColor(patientCount);

            const circle = L.circleMarker([area.lat, area.lng], {
                radius: radius,
                fillColor: color,
                color: "#ffffff",
                weight: 1,
                fillOpacity: 0.85,
                opacity: 0.9
            }).addTo(map);

            // Tooltip
            circle.bindTooltip(
                `<div style="font-size:14px;font-weight:600;">
                    ${area.name}
                </div>
                <div style="font-size:12px;">
                    Patients: <strong>${patientCount}</strong>
                </div>`,
                {
                    permanent: false,
                    direction: "top",
                    offset: [0, -radius],
                    opacity: 0.9,
                    className: "heatmap-tooltip"
                }
            );

            // Hover animation
            circle.on("mouseover", function () {
                this.setStyle({
                    radius: radius * 1.4,
                    weight: 2,
                    fillOpacity: 1
                });
            });

            circle.on("mouseout", function () {
                this.setStyle({
                    radius: radius,
                    weight: 1,
                    fillOpacity: 0.85
                });
            });

            circleMarkers.push(circle);
        });

        // Center map to branch
        if (branchData.center) {
            map.setView(branchData.center, 12);
        }

        // Update info panel
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

        const startName = monthNames[startMonth - 1];
        const endName = monthNames[endMonth - 1];

        const branchName = branch.charAt(0).toUpperCase() + branch.slice(1).replace('-', ' ');

        document.getElementById('selection-info').textContent =
            `${branchName} ‚Ä¢ ${startName} ‚Üí ${endName} ${year}`;

        document.getElementById('patient-count').textContent = totalPatients;

        console.log(`Heatmap updated for ${branchName}, ${startName} to ${endName} ${year}`);
        
    } catch (error) {
        console.error('Error generating heatmap:', error);
        alert('Error updating heatmap. See console.');
    }
}


        window.addEventListener('load', () => {
            initMap();
            generateHeatmap();
        });
    </script>
    <footer class="app-footer">
    <p>Designed & Developed by <strong>Ansh Khantwal</strong></p>
</footer>
</body>
</html>
